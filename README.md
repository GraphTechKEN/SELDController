# SELD Controller
- 国鉄型SELD式車両向けのマスコンやブレーキ弁などの入力操作と速度計や電圧計のメーターなどの外部表示器をBVEやJRETSと連動させるものです。

> [!TIP]
>- BVE Trainsim 5.8と6に対応
>- JRETSなど一部の鉄道シミュレーターなどの操作が可能(メーター類は不動)
>- Arduino Microを使用し、HIDキーボード機能を利用したキー入力と、シリアルポートを介した機器連動を同時に実現
>- 部品の配線やポテンショの追加改造のみで実装可
>- 付属の[調整ソフト](https://github.com/GraphTechKEN/MC53_ME38_BVE_VM/releases/)で、ブレーキ弁角度や速度計補償などの細かい設定も可
>- [こちら](115-1000_Display)の115系1000番台向け表示灯拡張基板を製作し接続すると、メーターパネルの表示灯(一部)も連動可能。こちらを利用すると、気合と根性で圧力計やATS-P機器などとも連動できるようになるかもしれません
>- ※SELD (国鉄型)応荷重弁付き発電ブレーキ併用電磁直通空気ブレーキシステムの名称

## 製作方法
~~実装済基板とME38専用センサのセットは[こちら](http://graphtechken.booth.pm/items/6223832)~~   
未実装生基板は[こちら](https://graphtechken.booth.pm/items/6901620)
実装済基板は[こちら](https://graphtechken.booth.pm/items/7677558)

1. 部品表は[こちら](部品表.pdf)
2. 基板は秋月電子製片面紙エポキシ・ユニバーサル基板　Ａの小タイプ(AE-5)またはサンハヤト製(ICB-97 1.2mm またはICB-97B 1.6mm)を推奨します。
3. 使用マイコンはArduino Microの純正品です。それ以外では正しく動作しないかピン配置が異なりますのでサポート対象外となります。ご注意ください。
4. 10kΩの集合抵抗は8素子タイプで、コモンを1番ピンとした場合は2番目と3番目のピンをカットしてください。コモン(1番ピン)は実態配線図の下側です。
5. こちらの[回路図通り](ME38_MC53_BVE_VM_V4.2.0.6.pdf)に配線[完全版(実態配線図)](ME38_MC53_BVE_VM_V4.2.0.6.png)します。(完全版は下のⅰとⅱ両方に対応します、青線がはんだ面、赤線がジャンパワイヤーです)  
   1. [標準版(実態配線図)](ME38_MC53_BVE_VM_V4.2.0.6_Normal.png)  
      基本的にはこちらの構成を推奨いたします。回路図上のJP23をショートさせます。  
   2. [軽量版(実態配線図)](ME38_MC53_BVE_VM_V4.2.0.6_Simple.png)  
      MCP4725(DA変換)およびMCP3008(AD変換)を廃止したエコノミー版です。回路図上のJP13,JP21,JP22をショートさせます。PWM制御とマイコンによる直接制御となりますが、後の配線ショートや過電圧印可によってマイコンを破損させた場合のリスクが大きいです。分解能が1023→255段階まで下がるので、メーターの動きをよく見るとカクカクします。また、PWMは高周波を発生させるため、メーターのデリケートな軸受けやバネが共振して寿命を早める可能性があります。こちらを使用する場合は、#define SIMPLE をスケッチで定義してコンパイルしてください。
7. 接続コネクタはDF1Bで記載していますが、2.54mmピッチであれば何でも構いません。他にはXHコネクタ(ベース付きポストサイド型)があります。シンプルなピンヘッダ(オスL型)でも接続出来ますが、不意な配線抜けがリスクです。もちろん直接配線しても問題ありませんが、作業性を考慮するとコネクタ化を推奨します。コネクタピン番号は基板上面から見て反時計回りです。
8. Arduino MicroとMCP4725モジュールにはロングピンソケット(分割ロングピンソケット42P推奨、分割して使用)、MCP3008とMCP23S17にはそれぞれICソケット(14pin、28pin)を用いると、万が一ICを破損させてしまった時の交換が容易です。
9. AE-MCP4725の基板裏面はSDAとSCLのプルアップのみハンダでジャンパー接続(J1とJ2)します。A0はピンに配線しています。
10. Arduino IDE使用時は、「Adafruit MCP23017 Arduino Library」と「Adafruit_MCP4725 Arduino Library」をライブラリマネージャーからインストールしてください。
11. メーター調整用可変抵抗は、実体配線図の向きで取り付けると、回転方向がメーターと一致します。
12. ブレーキ弁の回転方向とシミュレータ上のブレーキ方向が逆の場合は、1番ピン+5Vと3番ピンGndを逆に接続してください。
13. 本基板単体で使用する場合は、シリアル通信端子UART(Serial1)の+5VとRX(1番ピンと3番ピン)をショートさせてください。
   ![実態配線図](ME38_MC53_BVE_VM_V4.2.0.6.png)

> [!WARNING]
>- Arduino Micro のUSBコネクタに力を加えると簡単にもげます。マイコン引き抜き時やUSBケーブル抜差時は特にご注意ください。 
>- 配線が1本でも異なると所望の動作はしません。SPIとI2Cのバスライン、+5VとGNDのショートは特に注意してください。
>- 本開発品によるいかなる破損や不具合等が生じても当方はいかなる責任を負いかねますので、ご了承ください。
>- BU0836を使用した外部機器とは相性不具合を起こす場合があります。ご注意ください。

> [!TIP]
>- Serial1出力と5V出力は、[表示灯類](https://github.com/GraphTechKEN/115-1000_Display)、[圧力制御](https://github.com/GraphTechKEN/Densei)など拡張用のために用います。
>- Serial1出力(Tx)：USBからのSerial電文をそのままSerial1から他基板へ渡します。
>- Serial1入力(Rx):他基板(表示基板など)から本基板へ信号を渡します。
>- 331e線が実車ではGndですが、その配線ですと力行しない限りレバーサの前進(4線)と後進(5線)が判別できないため、331h線をGndとし、331e線を1段目に付け替えています。

## プログラム方法
> [!TIP]
>- プログラム(ファーム)書込み機能をSeldControllerに内蔵しました。(※完全版/標準版のみ)
>- ReleaseよりSeldController.XXXX.zipをDL後、識別子(右クリック→プロパティ)を削除後展開します。
>- Arduino IDEがインストールされていない場合、ドライバのインストールが開始されます。正しくインストールできない場合や表示が出ない場合はArduino IDEを別途インストールしてください。
>- 製作した基板のマイコン(Arduino Micro)とPCを接続します。
>- Arduino Microのポートを左上選択メニューから選び、接続を開始します。
>- 中ほど右側の「ファームウェア」タブから「ファーム書込み」ボタンをクリックします。※新品のArduino Microの場合は2回同じファーム書込みを行ってください。2回目はポート番号が変わっている場合がありますのでご注意ください。  

## 設定方法
SeldController.exeを開きます。  
画面左上、Arduino Microが接続されているCOMポートを選択後、通信開始をクリックします。  
各所設定を確認します。()内がデフォルト値です。  

## BVEとの連動方法
> [!TIP]
>- 専用プラグイン化しました(SeldEX)。
>- ReleaseよりSeldController.XXXX.zipをDL後、識別子(右クリック→プロパティ)を削除後展開します。以外1または2を行います。  
>- 通信開始後、「BveEXプラグイン」タブから「インストール」ボタンをクリックします。
>- BVE Trainsimを起動し、右クリックメニューから適宜設定を行ってください。

## その他・注意事項
> [!WARNING]
> `改変再配布も制限なく使用していただいて構いませんが、ご使用は自己責任でお願いいたします。`  
> `本内容による損害等については一切の責任を負いかねます。`  
> `※改造・再配布される際は各著作権表示をお願いいたします。`  

## 謝辞
本開発品はツナギ図 laboratory(ED67900-5様代表ほか)の出版冊子[実物部品を使った運転シミュレータのつくりかた](https://booth.pm/ja/items/1756291)を参考にしております。  
本開発品は[まさき氏 X](https://x.com/ME48GEB1)にご協力いただきました。 
本開発品は[万葉超音波温泉クハ115-1106](https://x.com/manyoonsen)にご協力いただきました。
また多数の方々のご協力をいただきました、この場を借りて御礼申し上げます。

